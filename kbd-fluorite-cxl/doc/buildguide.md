# fluorite CXL Build Guide
fluorite CXL のビルドガイドです

最初に全てに目を通して流れを掴んでから作業に入るとスムースに製作を進められると思います

- I.　同梱品と別途購入するもの
- II.　必要な工具
- III.　ファームウェアのビルド環境構築
- IV.　キーボードの組み立て
- V.　ファームウェアのビルドと書き込み
- VI.　キーマップのカスタマイズ


# I.　同梱品と別途購入するもの
### 同梱品



|パーツ|個数|備考|
|--|--|--|
|メインPCB（基板）|2枚|リバーシブル|
|トッププレート|2枚|リバーシブル|
|ボトムプレート|2枚|リバーシブル|
|アクリルプレート（ProMicro保護用）|2枚|リバーシブル|
|アクリルプレート（TRRSジャック保護用）|2枚|リバーシブル|
|リセット用タクトスイッチ|2個|
|TRRSジャック|2個|
|表面実装ダイオード|140個|予備10個
|クッションゴム|10個|
|スペーサー（M2 7mm）|24本|予備2本|
|スペーサー（M2 10mm）|16本|予備2本|
|黒色焼付塗装βチタンネジ （M2 4mm）|48本|◆黒鍵modelのみ　予備2本|
|ステンレスネジ （M2 4mm）|32本|◆黒鍵modelのみ　予備2本|
|ステンレスネジ （M2 4mm）|80本|◇白鍵modelのみ　予備4本|


### 別途購入品
- ProMicro：2個 [https://yushakobo.jp/shop/promicro-spring-pinheader/](https://yushakobo.jp/shop/promicro-spring-pinheader/)
- スプリングピンヘッダー：４個（12ピン）上記のセットに入っています
- TRRSケーブル：１本 （左右のキーボードを接続するのに使います）
- Micro USBケーブル：１本（PCとの接続に使います）
- CherryMX互換スイッチ用ソケット（Kailh製）：１４０個 [https://yushakobo.jp/shop/a01ps/](https://yushakobo.jp/shop/a01ps/)
- CherryMX互換キースイッチ：１４０個
- CherryMX互換スイッチ用キーキャップ1Ｕ：１４０個
（一部1.25U、1.5Uが使えます）

# II.　必要な工具
- はんだごて（白光 FX600など）
- こて台（白光 FX633-01など）
- はんだ（白光 HEXSOL 0.6mmなど 細いのが使いやすいと思います）
- ドライバー（M2ネジ用）
- マスキングテープ
- ピンセット
- テスター
- フラックス、フラックスクリーナー
- エポキシ樹脂系接着剤（ProMicro補強用）


# III.　ファームウェアのビルド環境構築
[https://docs.qmk.fm/#/newbs_getting_started](https://docs.qmk.fm/#/newbs_getting_started)

QMK Firmware のサイトを参照して環境構築を行ってください
流れとしては以下のようになります

### MSYS2のインストール（windowsの場合です）
1. MSYS2のダウンロードを選んでインストールします[https://www.msys2.org](https://www.msys2.org/)
2. `pacman -Syu`
3. MSYS2を一旦閉じて、再起動後`pacman -Su`

### Gitのインストール
1. `pacman -S git`

### QMK firmwareのインストール
1. QMK Firmware を入手します
`git clone --recurse-submodules https://github.com/qmk/qmk_firmware.git`
2. ディレクトリ移動
`cd qmk_firmware`
3. インストール
`util/qmk_install.sh`


# IV.　キーボードの組み立て
PCB（基板）はリバーシブルになっていますので片方を左側、もう片方を右側としてください

**基板への部品の実装とはんだづけの向きは特に注意して下さい**

PCBに以下の順で部品を取り付けていきます（間違えてソケットを先につけてしまうとダイオードがつけにくくなりますので気をつけてください）

1. ProMicroの補強
2. 表面実装ダイオード
3. CherryMX互換スイッチ用ソケット
4. TRRSジャック
5. リセット用タクトスイッチ
6. ProMicroとスプリングピンヘッダー
7. トッププレートとPCB（基板）にスペーサーを取り付けます
8. キースイッチをトッププレートを通してからメイン基板に嵌めていきます
9. ボトムプレートを取り付けます
10. アクリルプレートを取り付けます 
11. ゴム足を取り付けます

---

### 1.ProMicroの補強
![ProMicro](https://github.com/ihotsuno/keyboard/blob/master/kbd-fluorite-cxl/doc/image/IMG_001.JPG)
エポキシ樹脂系接着剤をProMicroの端子の周りに盛って端子を補強しておくのをおすすめします
- エポキシ樹脂系接着剤が端子の穴から中に入っていかないように気をつけてください（Micro USBケーブルが挿さらなくなってしまいます）
- 端子の高さより上に盛り上げないように気をつけてください（プレートに干渉して組み立てが出来なくなってしまいます）

### 2.表面実装ダイオード（メインPCBの下側から部品とはんだづけを行います！）
![diode](https://github.com/ihotsuno/keyboard/blob/master/kbd-fluorite-cxl/doc/image/IMG_002.JPG)
**ダイオードには向きがあります**
**ダイオードの縦のライン**`｜｜｜　T4`（左側の方に１～３本ある縦線のこと）が描かれている側
**基板のシルクで縦のライン**`｜◁`（左側の方にある縦線のこと）が描かれている側の向きを合わせて取り付けて下さい
1. 片側のランドのみに予備はんだを軽く行います（右手ではんだごてを持つ場合は右側のランド）
2. **向きを確認したダイオード**をピンセットで持って、先ほど行った予備はんだをはんだごてで溶かしながらダイオードを取り付け位置に置きます
3. はんだごてを離してダイオードを固定します
4. 片足をはんだづけしたこの段階で以下を確認します
- ダイオードの向きはあっているか？
- ダイオードの両足がランドに左右均等に載っているか？
- 真横から見て浮いていないか？
5. 確認が出来たら反対側の足をはんだづけしておわりです
6. 左右の基板で合計１４０個取り付けます

### 3.CherryMX互換スイッチ用ソケット（メインPCBの下側から部品とはんだづけです！）
![socket](https://github.com/ihotsuno/keyboard/blob/master/kbd-fluorite-cxl/doc/image/IMG_003.JPG)
1. ダイオードと違い、今回は両側のランドに予備はんだを気持ち多めに行います
2. 基板のシルク印刷の向きに合うようにソケットを置きます
3. ソケットを基板に押し付けながら、片側の予備はんだを溶かしていきます
4. 反対側の足も同様に行います
5. もう一度、最初の足側を押しながらはんだごてをあてます
6. 左右の基板で１４０個取り付けます

### 4.TRRSジャックの取り付け（部品は上側、はんだづけは下側からです！）
![TRRS](https://github.com/ihotsuno/keyboard/blob/master/kbd-fluorite-cxl/doc/image/IMG_004.JPG)
1. 部品が浮きやすいのでマスキングテープでメインPCBに仮固定します
2. 足をはんだづけしていきます（となりの足とショートしないように）

### 5.リセット用タクトスイッチの取り付け（部品は上側、はんだづけは下側からです！）
![RESET](https://github.com/ihotsuno/keyboard/blob/master/kbd-fluorite-cxl/doc/image/IMG_005.JPG)
1. 部品をメインPCBのおもて側からはめ込みます
2. 裏面からはんだづけします

### 6.ProMicroをスプリングピンヘッダーにはんだづけします（スプリングピンヘッダーとメインPCBははんだづけしません！）
![ProMicroWindows](https://github.com/ihotsuno/keyboard/blob/master/kbd-fluorite-cxl/doc/image/IMG_006.JPG)
1.**ProMicroの基板の向き**と**スプリングピンヘッダーの窓の向き**を確認します
ProMicroは部品が載っている面が下側になります。スプリングピンヘッダーはパーツの片面に窓が開いていて、金具の先が顔を出している面があります。窓は上下どちらかによっていて、窓が近いほうをProMicro側にして接続します（両方とも）
2. はんだづけを行います。富士山型になればはんだ量は十分です（となりの足とショートしないように）
![SetProMicro](https://github.com/ihotsuno/keyboard/blob/master/kbd-fluorite-cxl/doc/image/IMG_007.JPG)
メインPCBにProMicroとスプリングピンヘッダーを嵌めて作業を行うとスプリングピンヘッダーが傾いたりせずに、はんだづけが行いやすいです

### 7.トッププレートとメインPCBにスペーサーを取り付けます
1. トッププレートの下側にスペーサー（7mm）が付くように、上側からネジで固定します（片側１２か所、黒鍵 ver.はチタンネジを使用）
2. メインPCBの上側、ProMicroとTRRSジャックの周辺にスペーサー（10mm）が付くように、下側からネジで固定します（片側８か所）
 
### 8.キースイッチをトッププレートを通してからメイン基板に嵌めていきます
1. メインPCBのソケットの向きに合うようにキースイッチの向きを確認しながらトッププレートに嵌めていきます（キースイッチの足が曲がっていたら、ゆっくり力をかけて真っ直ぐに直しておきます）
2. トッププレートに嵌まった７０個のキースイッチの向きと足が曲がっていないかをもう一度確認したらメイン基板に嵌めていきます
3. 位置を合わせてゆっくりと押し込んでいって下さい 

### 9.ボトムプレートを取り付けます
1. ボトムプレートをキーボード下側からネジで固定します（片側１２か所、黒鍵 ver.はチタンネジを使用）

### 10.アクリルプレートを取り付けます
**アクリルプレートは尖っている部分があるので気をつけてください**
ProMicro保護用とTRRSジャック保護用のアクリルプレートをキーボード上側にネジで固定します

### 11.ゴム足を取り付けます
キーボード下側にゴム足を取り付けます

 
# V.　ファームウェアのビルドと書き込み
### ファームウェアのビルド

fluorite CXL のファームウェアはQMK本家にまだマージされていません
[https://github.com/ihotsuno/qmk_firmware](https://github.com/ihotsuno/qmk_firmware)
においてあります

MSYS2のシェルからコマンドを入力してビルドを行います
qmk_firmwareのあるディレクトリに移動して以下のコマンドを入力します
```
make fluorite:default
```
---
### ファームウェアの書き込み
PCとfluorite CXLを接続し、以下のコマンドを入力します

```
make fluorite:default:avrdude
```

OKのログが続き、` your controller now... ` という状態になったら、キーボードのリセットスイッチを押すと書き込みが始まります

micro USBケーブルを差し替えて、左右2セット分書き込みを行ってください

無事にキー入力が出来ればお好きなキーキャップを取り付けて完成です。お疲れさまでした！


# VI.　キーマップのカスタマイズ
1. keymaps内のdefaultフォルダをコピーして、名前を付けます（例：custom）
2. custom内のkeymap.cを編集します
3. カスタマイズしたキーマップで書き込むには以下のようになります
` make fluorite:custom:avrdude ` 

### fluorite CXL デフォルトキーマップの解説
**ファームウェアのkeymap.cについて**
デフォルトでは以下の6レイヤーが用意されています
1. QWERTYレイヤー　アルファベット、基本的なキー
2. LOWERレイヤー　+　-　*　/
3. RAISEレイヤー　カーソル、HOME、END、_　;　:　\　@　|　`
4. CUSTOM1レイヤー　maya
5. CUSTOM2レイヤー　photoshop、clipstudio
6. ADJUSTレイヤー　(　)　[　]　{　}　<　>

- QWERTYレイヤーがデフォルトのレイヤーになります
- LOWERキーを押している間、LOWERレイヤーのキーが入力出来ます
- RAISEキーを押している間、RAISEレイヤーのキー入力が出来ます
- QWERTYレイヤー時に、TTCM1キーをダブルタップするとトグルでQWERTYレイヤーとCUSTOM1レイヤーが切り替わります
- CUSTOM1レイヤー時に、TTCM2キーをダブルタップするとトグルでCUSTOM1レイヤーとCUSTOM2レイヤーが切り替わります
- LOWERキーとRAISEキーを同時に押している間、ADJUSTレイヤーのキーが入力出来ます

---
**QWERTYレイヤー**
↓　TTCM1ダブルタップ　　　　↑　TTCM1ダブルタップ
**CUSTOM1レイヤー**
↓　TTCM2ダブルタップ　　　　↑　TTCM2ダブルタップ
**CUSTOM2レイヤー**

QWERTYレイヤーではTTCM1がアサインされているキーの場所にCUSTOM1レイヤーではTTCM2がアサインされています。これにより同じキーを連続でダブルタップすると次々と違うレイヤーへ移動が可能になっています（戻りはLOWERキーとRAISEキーのアサインされているキーの場所に同じ理屈で設定してあります。keymap.cを見てみてください）

現在のレイヤーがわからなくなったらQWERTYレイヤーでのLOWERキーかRAISEキーをダブルタップすれば戻れます
（CUSTOM1レイヤーにいた場合は１回、CUSTOM2レイヤーにいた場合は２回なので、トントンッ、トントンッとダブルタップを２回おこなえば必ずQWERTYレイヤーに戻れます）

ダブルタップの受付時間は` config.h `内の` #define  TAPPING_TERM  220 `の数値（220）を変更することで調整することが出来ます（単位はミリ秒。1秒=1000ミリ秒。220の設定ならば220ミリ秒以内に２回タップするとレイヤー変更を受け付けるという意味です）

---
keymap.cを修正すれば以下のようQWERTYからそれぞれのレイヤーに直接移動する挙動も作成出来ますし、シングルタップにしたり、レイヤー数を拡張することも可能です（ファームウェアの指定可能な最大数、サイズ内ならば）
**QWERTYレイヤー**
↓　TTCM1ダブルタップ　　　　↑　TTCM1ダブルタップ
**CUSTOM1レイヤー**

**QWERTYレイヤー**
↓　TTCM2ダブルタップ　　　　↑　TTCM2ダブルタップ
**CUSTOM2レイヤー**

**QWERTYレイヤー**
↓　TTCM3ダブルタップ　　　　↑　TTCM3ダブルタップ
**CUSTOM3レイヤー**
.
.
.